<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MediaPipe FaceMesh with 3D Hat Model - Safe Version</title>
  <!-- MediaPipe Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  <!-- Three.js and GLTFLoader Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.134/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif;
    }
    #output_canvas { position: absolute; top: 0; left: 0; }
    #three_canvas { position: absolute; top: 0; left: 0; }
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 12px;
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
    }
    #controls label {
      display: block;
      margin: 5px 0;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <video class="input_video" style="display: none;"></video>
    <canvas class="output_canvas" width="1280" height="720"
        style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
    <canvas id="three_canvas" width="1280" height="720"
        style="position: absolute; top: 0; left: 0; z-index: 2; pointer-events: none;"></canvas>
  </div>
  
  <div id="status">ğŸ”„ Äang khá»Ÿi táº¡o...</div>
  
  <div id="controls">
    <h4>ğŸ›ï¸ Controls</h4>
    <label>
      <input type="checkbox" id="show-mesh" checked> Show Face Mesh
    </label>
    <label>
      <input type="checkbox" id="enable-depth-mask" checked> ğŸ­ Enable Depth Masking
    </label>
    <label>
      <input type="checkbox" id="show-face-mask"> ğŸ” Show Face Mask (Debug)
    </label>
  </div>

  <script>
    console.log('ğŸš€ Safe version starting...');
    
    // Helper function Ä‘á»ƒ safely add event listeners
    function safeAddEventListener(elementId, event, callback) {
      const element = document.getElementById(elementId);
      if (element) {
        element.addEventListener(event, callback);
        console.log(`âœ… Added listener for ${elementId}`);
        return true;
      } else {
        console.warn(`âš ï¸ Element ${elementId} not found`);
        return false;
      }
    }
    
    // Update status function
    function updateStatus(msg) {
      const statusEl = document.getElementById('status');
      if (statusEl) {
        statusEl.textContent = msg;
      }
      console.log(msg);
    }
    
    // Wait for DOM
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“„ DOM loaded, starting initialization...');
      
      try {
        // Global variables
        let showMesh = true;
        let enableDepthMask = true;
        let showFaceMaskDebug = false;
        let faceMaskMesh = null;
        
        updateStatus('ğŸ¥ Setting up MediaPipe...');
        
        // MediaPipe Setup
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        if (!videoElement || !canvasElement) {
          throw new Error('Canvas elements not found');
        }
        
        canvasElement.width = 1280;
        canvasElement.height = 720;
        const canvasCtx = canvasElement.getContext('2d');
        
        updateStatus('ğŸ¨ Setting up Three.js...');
        
        // Three.js Setup
        const threeCanvas = document.getElementById('three_canvas');
        if (!threeCanvas) {
          throw new Error('Three.js canvas not found');
        }
        
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, 1280 / 720, 0.1, 1000);
        camera.position.z = 5;
        
        const renderer = new THREE.WebGLRenderer({ 
          canvas: threeCanvas, 
          alpha: true,
          stencil: true,
          depth: true
        });
        renderer.setSize(1280, 720);
        renderer.autoClear = false;
        
        // Add lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(0, 1, 1);
        scene.add(directionalLight);
        
        // Depth mask material
        const depthMaskMaterial = new THREE.MeshBasicMaterial({
          colorWrite: false,
          depthWrite: true,
          depthTest: true,
          transparent: false,
          visible: true
        });
        
        // Test objects
        const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
        const material = new THREE.MeshPhongMaterial({ color: 0xff0000 });
        const cube = new THREE.Mesh(geometry, material);
        scene.add(cube);
        
        // Render function
        function renderWithDepthMask() {
          if (!enableDepthMask || !faceMaskMesh) {
            renderer.render(scene, camera);
            return;
          }
          
          renderer.clear(true, true, false);
          
          // Hide other objects
          const objectsToHide = [];
          scene.traverse((child) => {
            if (child !== faceMaskMesh && child.visible) {
              objectsToHide.push(child);
              child.visible = false;
            }
          });
          
          // Render face mask
          faceMaskMesh.visible = true;
          faceMaskMesh.material = showFaceMaskDebug ? 
            new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.3 }) :
            depthMaskMaterial;
          renderer.render(scene, camera);
          
          // Restore visibility
          objectsToHide.forEach(obj => obj.visible = true);
          faceMaskMesh.visible = showFaceMaskDebug;
          
          renderer.render(scene, camera);
        }
        
        // Animation loop
        function animate() {
          cube.rotation.x += 0.01;
          cube.rotation.y += 0.01;
          renderWithDepthMask();
          requestAnimationFrame(animate);
        }
        
        updateStatus('âœ… Three.js ready!');
        
        // Setup event listeners safely
        safeAddEventListener('show-mesh', 'change', (e) => {
          showMesh = e.target.checked;
        });
        
        safeAddEventListener('enable-depth-mask', 'change', (e) => {
          enableDepthMask = e.target.checked;
          updateStatus(enableDepthMask ? 'ğŸ­ Depth masking enabled' : 'ğŸ­ Depth masking disabled');
        });
        
        safeAddEventListener('show-face-mask', 'change', (e) => {
          showFaceMaskDebug = e.target.checked;
          updateStatus(showFaceMaskDebug ? 'ğŸ” Debug mode ON' : 'ğŸ” Debug mode OFF');
        });
        
        // Start animation
        animate();
        updateStatus('ğŸ® Rendering started!');
        
        // MediaPipe configuration
        const faceMesh = new FaceMesh({
          locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
          }
        });
        
        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults((results) => {
          canvasCtx.save();
          canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
          canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
          
          if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];
            
            if (showMesh) {
              // Draw face mesh
              drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, 
                { color: '#50DCF0', lineWidth: 1, circleRadius: 1 });
            }
            
            updateStatus(`ğŸ˜Š Face detected (${landmarks.length} landmarks)`);
            
            // Create simple face mask for depth testing
            if (!faceMaskMesh) {
              const maskGeometry = new THREE.PlaneGeometry(2, 2);
              faceMaskMesh = new THREE.Mesh(maskGeometry, depthMaskMaterial);
              faceMaskMesh.position.z = -2;
              scene.add(faceMaskMesh);
            }
          } else {
            updateStatus('ğŸ‘€ Looking for face...');
          }
          
          canvasCtx.restore();
        });
        
        // Camera setup
        const camera_setup = new Camera(videoElement, {
          onFrame: async () => {
            await faceMesh.send({ image: videoElement });
          },
          width: 1280,
          height: 720
        });
        
        camera_setup.start();
        updateStatus('ğŸ“¹ Camera started! All systems ready.');
        
      } catch (error) {
        console.error('âŒ Error:', error);
        updateStatus('âŒ Error: ' + error.message);
      }
    });
  </script>
</body>
</html>